<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio de Pendura</title>
    <style>
        /* Estilo do corpo */
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9; /* Cor de fundo leve */
            padding: 20px; /* Margem em torno do conte√∫do */
            box-sizing: border-box;
        }

        /* Estilo do cabe√ßalho e rodap√© */
        header, footer {
            background-color: #fff; /* Cor de fundo branca */
            padding: 20px; /* Espa√ßamento interno */
            border-radius: 8px; /* Bordas arredondadas */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Sombra leve */
            margin-bottom: 20px; /* Espa√ßo abaixo do cabe√ßalho/rodap√© */
        }

        h1 {
            color: #333; /* Cor do t√≠tulo */
            text-align: center; /* Centralizar o t√≠tulo */
        }

        /* Estilo do formul√°rio */
        .form-group {
            margin-bottom: 15px; /* Espa√ßo entre grupos de campos */
        }

        /* Flexbox para alinhar itens no formul√°rio */
        .form-row {
            display: flex; /* Usar flexbox */
            justify-content: space-between; /* Espa√ßo entre itens */
            align-items: center; /* Alinhamento vertical */
            margin-bottom: 15px; /* Espa√ßo abaixo da linha */
        }

        .options {
            margin-right: 20px; /* Espa√ßo √† direita entre grupos */
        }

        .radio-group {
            display: flex; /* Flexbox para op√ß√µes de r√°dio */
            gap: 10px; /* Espa√ßo entre op√ß√µes */
            margin-top: 5px; /* Espa√ßo acima do grupo de r√°dio */
        }

        .user-data {
            margin-top: 5px; /* Espa√ßo acima dos dados do usu√°rio */
            font-style: italic; /* Estilo opcional para os dados do usu√°rio */
            color: #666; /* Cor dos dados do usu√°rio */
        }

        label {
            display: block; /* Exibir cada label em nova linha */
            margin-bottom: 5px; /* Espa√ßo abaixo de cada label */
            color: #555; /* Cor das labels */
        }

        /* Estilo dos campos de entrada */
        input[type="text"], select {
            width: 100%; /* Largura total */
            padding: 10px; /* Espa√ßamento interno */
            border: 1px solid #ccc; /* Borda leve */
            border-radius: 4px; /* Bordas arredondadas */
            box-sizing: border-box; /* Inclui padding e border no c√°lculo da largura */
        }

        input[type="radio"] {
            margin-right: 5px; /* Espa√ßo √† direita dos bot√µes de r√°dio */
        }

        /* Estilo dos bot√µes */
        button {
            padding: 10px 15px; /* Espa√ßamento interno */
            background-color: #06a52b; /* Cor de fundo do bot√£o */
            color: white; /* Cor do texto */
            border: none; /* Sem borda */
            border-radius: 5px; /* Bordas arredondadas */
            cursor: pointer; /* Cursor em forma de m√£o */
            transition: background-color 0.3s; /* Transi√ß√£o suave */
        }

        button:hover {
            background-color: #218838; /* Cor do bot√£o ao passar o mouse */
        }

        /* Estilo das se√ß√µes de CRUD */
        .crud-section {
            margin-bottom: 20px; /* Espa√ßo entre se√ß√µes */
            border: 1px solid #ccc; /* Borda leve */
            padding: 10px; /* Espa√ßamento interno */
            border-radius: 5px; /* Bordas arredondadas */
            background-color: #fff; /* Cor de fundo da se√ß√£o */
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1); /* Sombra leve */
        }

        .valor-bruto, .valor-desconto {
            font-weight: bold; /* Negrito para valores */
        }

        .declaracao {
            margin-top: 40px; /* Espa√ßo acima da declara√ß√£o */
            font-size: 14px; /* Tamanho da fonte */
            text-align: center; /* Centralizar texto */
            border-top: 1px solid #000; /* Linha acima */
            padding-top: 20px; /* Espa√ßamento acima do texto */
        }

        #dados-usuario {
            margin-top: 10px; 
            display: none; 
        }
        
        .delete-btn {
            background-color: #dc3545; 
            margin-left: 10px; 
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<header>
    <h1>Formul√°rio de Pendura</h1>

    <div class="form-group">
        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" onblur="buscarDadosCPF()" placeholder="Digite seu CPF">
        <div id="dados-usuario" class="user-data">
            <p><strong>Nome:</strong> <span id="nome"></span></p>
            <p><strong>Loja:</strong> <span id="loja"></span></p>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group options">
            <span>Selecione uma op√ß√£o:</span>
            <div class="radio-group">
                <label>
                    <input type="radio" name="opcao" value="desconto" checked> Desconto em folha
                </label>
                <label>
                    <input type="radio" name="opcao" value="brinde"> Anivers√°rio
                </label>
            </div>
        </div>

        <div class="form-group month-selection">
            <label for="mes">Referente ao m√™s:</label>
            <select id="mes">
                <option value="">Selecione o m√™s</option>
                <option value="Janeiro">Janeiro</option>
                <option value="Fevereiro">Fevereiro</option>
                <option value="Mar√ßo">Mar√ßo</option>
                <option value="Abril">Abril</option>
                <option value="Maio">Maio</option>
                <option value="Junho">Junho</option>
                <option value="Julho">Julho</option>
                <option value="Agosto">Agosto</option>
                <option value="Setembro">Setembro</option>
                <option value="Outubro">Outubro</option>
                <option value="Novembro">Novembro</option>
                <option value="Dezembro">Dezembro</option>
            </select>
        </div>
    </div>
</header>

<main>
    <div id="crud-container">
        <div class="crud-section">
            <label>C√≥digo do Produto: </label>
            <input type="text" class="codigo-produto" onblur="buscarDadosProduto(this)">
            <label>Quantidade: </label>
            <input type="number" class="quantidade-produto" min="1" value="1" oninput="atualizarValores(this)">
            <p><strong>Valor Bruto:</strong> R$ <span class="valor-bruto">0,00</span></p>
            <p><strong>Valor com Desconto (40%):</strong> R$ <span class="valor-desconto">0,00</span></p>
            <button type="button" class="delete-btn" onclick="removerCRUD(this)">üóëÔ∏è</button>
        </div>
    </div>
    <button type="button" onclick="adicionarCRUD()">Adicionar Produto</button>
    
    <div class="totais">
        <p>Total Bruto: R$ <span id="total-bruto">0,00</span></p>
        <p>Total com Desconto: R$ <span id="total-desconto">0,00</span></p>
    </div>
</main>

<footer>
    <button type="button" onclick="enviarDadosEgerarPDF()">Enviar e Gerar PDF</button>
</footer>

<script>
    async function buscarDadosCPF() {
        const cpf = document.getElementById('cpf').value;
        const url = 'https://script.google.com/macros/s/AKfycbzuVBfxd4Ac_tyrOFiZy71UTEQs0miiV41to-eqi0ifprDfbAf8u0FdnACPnMsXd4CQgw/exec';
        try {
            const response = await fetch(`${url}?cpf=${cpf}`);
            const data = await response.json();
            
            if (data.error) {
                alert(data.error);
                document.getElementById('dados-usuario').style.display = 'none';
            } else {
                document.getElementById('nome').innerText = data.nome || 'N√£o encontrado';
                document.getElementById('loja').innerText = data.loja || 'N√£o encontrado';
                document.getElementById('dados-usuario').style.display = 'block';
            }
        } catch (error) {
            console.error('Erro ao buscar dados do CPF:', error);
        }
    }

    async function buscarDadosProduto(input) {
    const codigoProduto = input.value;
    const url = 'https://script.google.com/macros/s/AKfycbzuVBfxd4Ac_tyrOFiZy71UTEQs0miiV41to-eqi0ifprDfbAf8u0FdnACPnMsXd4CQgw/exec';
    try {
        const response = await fetch(`${url}?codigo=${codigoProduto}`);
        const data = await response.json();

        if (data.error) {
            alert(data.error);
            input.parentElement.querySelector('.valor-bruto').innerText = '0,00';
            input.parentElement.querySelector('.valor-desconto').innerText = '0,00';
        } else {
            input.parentElement.querySelector('.valor-bruto').innerText = formatarMoeda(data.valorBruto);
            input.parentElement.querySelector('.valor-desconto').innerText = formatarMoeda(data.valorDesconto);
            atualizarValores(input.parentElement.querySelector('.quantidade-produto')); // Atualiza os valores automaticamente
            atualizarTotais();
        }
    } catch (error) {
        console.error('Erro ao buscar dados do produto:', error);
    }
}

    function formatarMoeda(valor) {
        return (valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }).replace('R$', '').trim();
    }

    function atualizarValores(input) {
    const container = input.parentElement;
    const valorBruto = parseFloat(container.querySelector('.valor-bruto').innerText.replace(',', '.').replace('R$ ', '').trim()) || 0;
    const quantidade = parseInt(container.querySelector('.quantidade-produto').value) || 0;
    const descontoSelecionado = document.querySelector('input[name="opcao"]:checked').value;

    let valorComDesconto;

    // L√≥gica para calcular o valor com desconto
    if (descontoSelecionado === 'desconto') {
        valorComDesconto = valorBruto * quantidade * 0.6; // Aplicando desconto de 40%
    } else if (descontoSelecionado === 'brinde') {
        valorComDesconto = 0; // Valor zerado para brinde
    } else {
        valorComDesconto = valorBruto * quantidade; // Sem desconto padr√£o
    }

    // Atualizando o valor com desconto e garantindo que √© formatado
    container.querySelector('.valor-desconto').innerText = formatarMoeda(valorComDesconto);
    atualizarTotais(); // Atualiza os totais ao final
}

function atualizarTotais() {
    let totalBruto = 0;
    let totalDesconto = 0;
    const sections = document.querySelectorAll('.crud-section');
    sections.forEach(section => {
        const valorBruto = parseFloat(section.querySelector('.valor-bruto').innerText.replace(',', '.').replace('R$ ', '').trim()) || 0;
        const valorDesconto = parseFloat(section.querySelector('.valor-desconto').innerText.replace(',', '.').replace('R$ ', '').trim()) || 0;
        totalBruto += valorBruto;
        totalDesconto += valorDesconto;
    });

    document.getElementById('total-bruto').innerText = formatarMoeda(totalBruto);
    document.getElementById('total-desconto').innerText = formatarMoeda(totalDesconto);
}
    function adicionarCRUD() {
        const crudContainer = document.getElementById('crud-container');
        const newSection = document.createElement('div');
        newSection.classList.add('crud-section');
        newSection.innerHTML = `
            <label>C√≥digo do Produto: </label>
            <input type="text" class="codigo-produto" onblur="buscarDadosProduto(this)">
            <label>Quantidade: </label>
            <input type="number" class="quantidade-produto" min="1" value="1" oninput="atualizarValores(this)">
            <p><strong>Valor Bruto:</strong> R$ <span class="valor-bruto">0,00</span></p>
            <p><strong>Valor com Desconto (40%):</strong> R$ <span class="valor-desconto">0,00</span></p>
            <button type="button" class="delete-btn" onclick="removerCRUD(this)">üóëÔ∏è</button>
        `;
        crudContainer.appendChild(newSection);
    }

    function removerCRUD(button) {
        const crudSection = button.closest('.crud-section');
        crudSection.remove();
        atualizarTotais();
    }

    async function enviarDadosEgerarPDF() { 
    const cpf = document.getElementById('cpf').value; 
    const nome = document.getElementById('nome').innerText; 
    const loja = document.getElementById('loja').innerText; 
    const tipoOpcao = document.querySelector('input[name="opcao"]:checked')?.value || 'op√ß√£o padr√£o'; // Op√ß√£o padr√£o
    const mes = new Date().toLocaleString('pt-BR', { month: 'long' });

    const produtos = [];
    const quantidade = [];
    const totalDescontode40 = [];

    document.querySelectorAll('.crud-section').forEach(section => {
        const codigoProduto = section.querySelector('.codigo-produto').value;
        const quantidadeProduto = section.querySelector('.quantidade-produto').value;
        const valorDesconto = section.querySelector('.valor-desconto').innerText.replace(',', '.');

        produtos.push(codigoProduto); 
        quantidade.push(quantidadeProduto); 
        totalDescontode40.push(parseFloat(valorDesconto)); 
    });

    const dataEnvio = new Date().toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });

    const dataParaEnviar = {
        cpf,
        nome,
        produtos: produtos.join(', '), 
        quantidade: quantidade.join(', '), 
        totalDescontode40: totalDescontode40.reduce((a, b) => a + b, 0).toFixed(2).replace('.', ','), 
        dataEnvio,
        loja,
        tipoOpcao,
        mes
    };

    // Envio para o SheetMonkey
    try {
        const sheetMonkeyUrl = 'https://api.sheetmonkey.io/form/47VnTaUQ6XX3P2nRrm34rs';
        const response = await fetch(sheetMonkeyUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataParaEnviar)
        });

        // Verifica se a resposta √© bem-sucedida
        if (response.ok) {
            alert("Dados registrados com sucesso!");

            // Ap√≥s o envio dos dados, gerar o PDF
            gerarPDFDocumento(cpf, nome, loja, produtos, quantidade, totalDescontode40, tipoOpcao);
        } else {
            const errorData = await response.json(); // Para obter detalhes do erro
            alert("Erro ao registrar os dados: " + (errorData.message || "Erro desconhecido"));
        }

    } catch (error) {
        console.error("Erro ao enviar os dados:", error);
        alert("Erro na conex√£o com o servidor: " + error.message);
    }
}

function formatarReais(valor) {
    return valor.replace('.', ',');
}

function gerarPDFDocumento(cpf, nome, loja, produtos, quantidade, totalDescontode40, tipoOpcao) {
    const { jsPDF } = window.jspdf; // Acessar a biblioteca jsPDF

    // Criar uma nova inst√¢ncia do jsPDF
    const doc = new jsPDF();

    // Adicionar um t√≠tulo ao PDF
    doc.setFontSize(18);
    doc.text("Formul√°rio de Pendura", 14, 22);

    // Adicionar dados do CPF
    doc.setFontSize(12);
    doc.text(`CPF: ${cpf}`, 14, 40);

    // Adicionar dados do usu√°rio
    doc.text(`Nome: ${nome}`, 14, 50);
    doc.text(`Loja: ${loja}`, 14, 60);

    // Adicionar dados dos produtos
    let yOffset = 70; // Offset para a pr√≥xima linha
    produtos.forEach((codigoProduto, index) => {
        const quantidadeProduto = quantidade[index];
        const valorDesconto = totalDescontode40[index].toFixed(2).replace('.', ',');

        doc.text(`Produto: ${codigoProduto}, Quantidade: ${quantidadeProduto}, Valor com Desconto: R$ ${valorDesconto}`, 14, yOffset);
        yOffset += 10; // Aumentar o offset para a pr√≥xima linha
    });

    // Captura a op√ß√£o selecionada corretamente
    const valorDesconto = totalDescontode40.reduce((a, b) => a + b, 0).toFixed(2);
    let declaracaoTexto;

    // Criar a declara√ß√£o com base na op√ß√£o selecionada
    if (tipoOpcao === 'desconto') {
        declaracaoTexto = `Eu, ${nome}, CPF: ${cpf}, autorizo o desconto em folha no valor total de R$ ${formatarReais(valorDesconto)}.`;
    } else if (tipoOpcao === 'aniversario') {
        declaracaoTexto = `Eu, ${nome}, CPF: ${cpf}, declaro o recebimento do meu brinde de anivers√°rio no valor total de R$ ${formatarReais(valorDesconto)}.`;
    }

    // Adicionar a declara√ß√£o ao PDF
    const textoDeclaracao = doc.splitTextToSize(declaracaoTexto, 190); // Ajustar a largura conforme necess√°rio
    textoDeclaracao.forEach((linha) => {
        doc.text(linha, 10, yOffset);
        yOffset += 10; // Aumenta a coordenada y para a pr√≥xima linha
    });

    // Adicionar totais
    const totalBruto = totalDescontode40.reduce((a, b) => a + b, 0).toFixed(2).replace('.', ',');
    doc.text(`Total Bruto: R$ ${totalBruto}`, 14, yOffset);
    yOffset += 10;
    doc.text(`Total com Desconto: R$ ${formatarReais(valorDesconto)}`, 14, yOffset);
    yOffset += 10;

    // Adiciona a linha de assinatura e a data
    const linhaAssinaturaY = yOffset + 20; // Define a coordenada y para a linha de assinatura
    doc.text("____________________________", 10, linhaAssinaturaY); // Linha de assinatura
    doc.text(`Assinatura: ${nome}`, 10, linhaAssinaturaY + 5); // Nome do assinante

    // Captura a data e hor√°rio atuais
    const dataAtual = new Date();
    const dataFormatada = dataAtual.toLocaleString('pt-BR', { timeZone: 'UTC' });
    doc.text(`Data e Hor√°rio: ${dataFormatada}`, 10, linhaAssinaturaY + 15); // Data e hor√°rio

    // Salvar o PDF
    doc.save('formulario_pendura.pdf');
}
</script>
</body>
</html>